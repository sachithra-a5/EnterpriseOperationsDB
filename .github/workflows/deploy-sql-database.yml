# CI/CD for Visual Studio Database Project (.sqlproj) â†’ SQL Server 2022
# Optimized for Self-Hosted Runners on Windows
# Deploy to Dev environment

name: Deploy SQL Database

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    environment: Dev
    defaults:
      run:
        shell: powershell
    env:
      DB_SERVER_NAME: ${{ vars.DB_SERVER_NAME }}
      DB_NAME: ${{ vars.DB_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup SqlPackage
        run: |
          dotnet tool install -g microsoft.sqlpackage --ignore-failed-sources 2>$null
          if ($LASTEXITCODE -ne 0) { dotnet tool update -g microsoft.sqlpackage }
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Auto-discover .sqlproj
        id: discover
        run: |
          $sqlproj = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.sqlproj" | Select-Object -First 1
          if (-not $sqlproj) { throw "No .sqlproj file found." }
          echo "sqlproj_path=$($sqlproj.FullName)" >> $env:GITHUB_OUTPUT
          echo "report_path=$env:GITHUB_WORKSPACE\deployment_report.xml" >> $env:GITHUB_OUTPUT

      - name: Build Database Project
        run: msbuild "${{ steps.discover.outputs.sqlproj_path }}" /p:Configuration=Release /p:Platform="Any CPU"

      - name: Locate Built Dacpac
        id: locate
        run: |
          # Use -like "*bin*" to correctly find the file path in PowerShell
          $dacpac = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.dacpac" | Where-Object { $_.FullName -like "*bin*" } | Select-Object -First 1
          if (-not $dacpac) { throw "Build succeeded but .dacpac was not found in any bin folder." }
          Write-Host "Found Dacpac at: $($dacpac.FullName)"
          echo "dacpac_path=$($dacpac.FullName)" >> $env:GITHUB_OUTPUT

      - name: Generate Deployment Report
        run: |
          sqlpackage /Action:DeployReport `
            /SourceFile:"${{ steps.locate.outputs.dacpac_path }}" `
            /TargetConnectionString:"""${{ secrets.DB_CONNECTION_STRING }}""" `
            /OutputPath:"${{ steps.discover.outputs.report_path }}"

      - name: Publish to SQL Server
        run: |
          sqlpackage /Action:Publish `
            /SourceFile:"${{ steps.locate.outputs.dacpac_path }}" `
            /TargetConnectionString:"""${{ secrets.DB_CONNECTION_STRING }}""" `
            /p:BlockOnPossibleDataLoss=true

      - name: Upload Deployment Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: ${{ steps.discover.outputs.report_path }}

      - name: Cleanup Workspace
        if: always()
        run: |
          Write-Host "Cleaning up build artifacts..."
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Include bin,obj | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          if (Test-Path "${{ steps.discover.outputs.report_path }}") { Remove-Item "${{ steps.discover.outputs.report_path }}" -Force }