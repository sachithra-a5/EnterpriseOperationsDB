# CI/CD for Visual Studio Database Project (.sqlproj) â†’ SQL Server 2022
# Optimized for Self-Hosted Runners on Windows
# Deploy to Dev environment using Global and Environment Variables

name: Deploy SQL Database

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    name: SQL Deployment to ${{ vars.ENV_NAME }}
    runs-on: [self-hosted, windows]
    environment: ${{ vars.ENV_NAME }}
    defaults:
      run:
        shell: powershell
    env:
      DB_SERVER_NAME: ${{ vars.DB_SERVER_NAME }}
      DB_NAME: ${{ vars.DB_NAME }}
      ENV_VALUE: ${{ vars.ENV_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup SqlPackage
        run: |
          # Idempotent install: checks if exists, otherwise installs/updates
          dotnet tool install -g microsoft.sqlpackage --ignore-failed-sources 2>$null
          if ($LASTEXITCODE -ne 0) { dotnet tool update -g microsoft.sqlpackage }
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Auto-discover .sqlproj
        id: discover
        run: |
          $sqlproj = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.sqlproj" | Select-Object -First 1
          if (-not $sqlproj) { throw "No .sqlproj file found." }
          echo "sqlproj_path=$($sqlproj.FullName)" >> $env:GITHUB_OUTPUT
          echo "report_path=$env:GITHUB_WORKSPACE\deployment_report.xml" >> $env:GITHUB_OUTPUT

      - name: Build Database Project
        run: msbuild "${{ steps.discover.outputs.sqlproj_path }}" /p:Configuration=Release /p:Platform="Any CPU"

      - name: Locate Built Dacpac
        id: locate
        run: |
          $dacpac = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.dacpac" | Where-Object { $_.FullName -like "*bin*" } | Select-Object -First 1
          if (-not $dacpac) { throw "Build succeeded but .dacpac was not found in any bin folder." }
          Write-Host "Found Dacpac at: $($dacpac.FullName)"
          echo "dacpac_path=$($dacpac.FullName)" >> $env:GITHUB_OUTPUT

      - name: Generate Deployment Report
        run: |
          $fullConnString = "Server=${{ env.DB_SERVER_NAME }};Database=${{ env.DB_NAME }};${{ secrets.DB_CONNECTION_STRING }}"
          sqlpackage /Action:DeployReport `
            /SourceFile:"${{ steps.locate.outputs.dacpac_path }}" `
            /TargetConnectionString:"""$fullConnString""" `
            /OutputPath:"${{ steps.discover.outputs.report_path }}" `
            /v:Environment="${{ env.ENV_VALUE }}"

      - name: Publish to SQL Server
        run: |
          $fullConnString = "Server=${{ env.DB_SERVER_NAME }};Database=${{ env.DB_NAME }};${{ secrets.DB_CONNECTION_STRING }}"
          sqlpackage /Action:Publish `
            /SourceFile:"${{ steps.locate.outputs.dacpac_path }}" `
            /TargetConnectionString:"""$fullConnString""" `
            /p:BlockOnPossibleDataLoss=true `
            /v:Environment="${{ env.ENV_VALUE }}"

      - name: Add Report to Job Summary
        if: always()
        run: |
          if (Test-Path "${{ steps.discover.outputs.report_path }}") {
            [xml]$xml = Get-Content "${{ steps.discover.outputs.report_path }}"
            $ops = $xml.DeploymentReport.Operations.Operation
            
            echo "### ðŸš€ Deployment Summary: ${{ env.ENV_VALUE }}" >> $env:GITHUB_STEP_SUMMARY
            if ($ops) {
              echo "| Operation | Object Type | Target Name |" >> $env:GITHUB_STEP_SUMMARY
              echo "| :--- | :--- | :--- |" >> $env:GITHUB_STEP_SUMMARY
              foreach ($op in $ops) {
                echo "| $($op.Name) | $($op.Item.Type) | $($op.Item.Name) |" >> $env:GITHUB_STEP_SUMMARY
              }
            } else {
              echo "âœ… No schema changes detected. Database is already up to date." >> $env:GITHUB_STEP_SUMMARY
            }
          } else {
            echo "### âš ï¸ Deployment Report not found." >> $env:GITHUB_STEP_SUMMARY
          }

      - name: Deploy PowerShell scripts to target folder
        run: |
          $destPath = "${{ vars.SCRIPTS_DESTINATION_PATH }}"
          if ([string]::IsNullOrWhiteSpace($destPath)) {
            throw "SCRIPTS_DESTINATION_PATH is not set in GitHub Variables."
          }
          $sourcePath = Join-Path $env:GITHUB_WORKSPACE "Scripts\PowerShell"
          if (Test-Path $sourcePath) {
            New-Item -ItemType Directory -Path $destPath -Force | Out-Null
            Copy-Item -Path (Join-Path $sourcePath "*.ps1") -Destination $destPath -Force
            Write-Host "Successfully copied scripts to $destPath"
          }

      - name: Upload Deployment Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ env.ENV_VALUE }}
          path: ${{ steps.discover.outputs.report_path }}

      - name: Cleanup Workspace
        if: always()
        run: |
          Write-Host "Cleaning up build artifacts on self-hosted runner..."
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Include bin,obj | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          if (Test-Path "${{ steps.discover.outputs.report_path }}") { Remove-Item "${{ steps.discover.outputs.report_path }}" -Force }