# CI/CD for Visual Studio Database Project (.sqlproj) â†’ SQL Server 2022
# Job 1: Build & generate SQL script + report. Job 2: Deploy (after manual approval).

name: Deploy SQL Database

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  # JOB 1: Build the project and generate the SQL Preview Script
  build_preview:
    name: Build & Generate Script for ${{ vars.ENV_NAME }}  
    runs-on: [self-hosted, windows]
    environment: ${{ vars.ENV_NAME }}
    defaults:
      run:
        shell: powershell
    env:
      DB_SERVER_NAME: ${{ vars.DB_SERVER_NAME }}
      DB_NAME: ${{ vars.DB_NAME }}
      ENV_VALUE: ${{ vars.ENV_NAME }}
    outputs:
      sqlproj_path: ${{ steps.discover.outputs.sqlproj_path }}
      report_path: ${{ steps.discover.outputs.report_path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup SqlPackage
        run: |
          dotnet tool install -g microsoft.sqlpackage --ignore-failed-sources 2>$null
          if ($LASTEXITCODE -ne 0) { dotnet tool update -g microsoft.sqlpackage }
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Auto-discover .sqlproj
        id: discover
        run: |
          $sqlproj = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.sqlproj" | Select-Object -First 1
          if (-not $sqlproj) { throw "No .sqlproj file found." }
          echo "sqlproj_path=$($sqlproj.FullName)" >> $env:GITHUB_OUTPUT
          echo "report_path=$env:GITHUB_WORKSPACE\deployment_report.xml" >> $env:GITHUB_OUTPUT

      - name: Build Database Project
        run: msbuild "${{ steps.discover.outputs.sqlproj_path }}" /p:Configuration=Release /p:Platform="Any CPU"

      - name: Generate Script & Report
        run: |
          $dacpac = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.dacpac" | Where-Object { $_.FullName -like "*bin*" } | Select-Object -First 1
          if (-not $dacpac) { throw "Build succeeded but .dacpac was not found." }
          $fullConnString = "Server=${{ env.DB_SERVER_NAME }};Database=${{ env.DB_NAME }};${{ secrets.DB_CONNECTION_STRING }}"

          sqlpackage /Action:Script `
            /SourceFile:"$($dacpac.FullName)" `
            /TargetConnectionString:"""$fullConnString""" `
            /OutputPath:"$env:GITHUB_WORKSPACE\deployment_preview.sql" `
            /v:Environment="${{ env.ENV_VALUE }}"

          sqlpackage /Action:DeployReport `
            /SourceFile:"$($dacpac.FullName)" `
            /TargetConnectionString:"""$fullConnString""" `
            /OutputPath:"${{ steps.discover.outputs.report_path }}" `
            /v:Environment="${{ env.ENV_VALUE }}"

      - name: Upload Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: sql-deployment-package
          path: |
            deployment_preview.sql
            deployment_report.xml
            **/*.dacpac
            Scripts/PowerShell/

  # JOB 2: Execute Deployment (requires manual approval via Environment)
  deploy:
    name: SQL Deployment to ${{ vars.ENV_NAME }}
    needs: build_preview
    runs-on: [self-hosted, windows]
    environment: ${{ vars.ENV_NAME }}
    defaults:
      run:
        shell: powershell
    env:
      DB_SERVER_NAME: ${{ vars.DB_SERVER_NAME }}
      DB_NAME: ${{ vars.DB_NAME }}
      ENV_VALUE: ${{ vars.ENV_NAME }}

    steps:
      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: sql-deployment-package

      - name: Setup SqlPackage
        run: |
          dotnet tool install -g microsoft.sqlpackage --ignore-failed-sources 2>$null
          if ($LASTEXITCODE -ne 0) { dotnet tool update -g microsoft.sqlpackage }
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Publish to SQL Server
        run: |
          $dacpac = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.dacpac" | Select-Object -First 1
          if (-not $dacpac) { throw "No .dacpac found in deployment package." }
          $fullConnString = "Server=${{ env.DB_SERVER_NAME }};Database=${{ env.DB_NAME }};${{ secrets.DB_CONNECTION_STRING }}"

          sqlpackage /Action:Publish `
            /SourceFile:"$($dacpac.FullName)" `
            /TargetConnectionString:"""$fullConnString""" `
            /p:BlockOnPossibleDataLoss=true `
            /v:Environment="${{ env.ENV_VALUE }}"

      - name: Add Report to Job Summary
        if: always()
        run: |
          $summaryFile = $env:GITHUB_STEP_SUMMARY
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          function Add-SummaryLine { param([string]$text); [System.IO.File]::AppendAllLines($summaryFile, [string[]]$text, $utf8NoBom) }

          if (Test-Path "deployment_report.xml") {
            [xml]$xml = Get-Content "deployment_report.xml" -Encoding UTF8
            $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
            $ns.AddNamespace("d", "http://schemas.microsoft.com/sqlserver/dac/DeployReport/2012/02")
            $ops = $xml.SelectNodes("//d:Operation", $ns)
            Add-SummaryLine "### Deployment Summary: ${{ env.ENV_VALUE }}"
            if ($ops -and $ops.Count -gt 0) {
              Add-SummaryLine "| Operation | Object Type | Target Name |"
              Add-SummaryLine "| :--- | :--- | :--- |"
              foreach ($op in $ops) {
                $opName = $op.GetAttribute("Name")
                foreach ($item in $op.SelectNodes("d:Item", $ns)) {
                  Add-SummaryLine "| $opName | $($item.GetAttribute('Type')) | $($item.GetAttribute('Value')) |"
                }
              }
            } else {
              Add-SummaryLine "[OK] No schema changes detected. Database is already up to date."
            }
          } else {
            Add-SummaryLine "### [WARNING] Deployment Report not found."
          }

      - name: Deploy PowerShell scripts to target folder
        run: |
          $destPath = "${{ vars.SCRIPTS_DESTINATION_PATH }}"
          if ([string]::IsNullOrWhiteSpace($destPath)) {
            throw "SCRIPTS_DESTINATION_PATH is not set in GitHub Variables."
          }
          if (Test-Path "Scripts/PowerShell") {
            New-Item -ItemType Directory -Path $destPath -Force | Out-Null
            Copy-Item -Path "Scripts/PowerShell/*.ps1" -Destination $destPath -Force
            Write-Host "Successfully copied scripts to $destPath"
          }

      - name: Cleanup Workspace
        if: always()
        run: |
          Write-Host "Cleaning up runner..."
          Remove-Item -Path "deployment_preview.sql", "deployment_report.xml" -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Include bin,obj | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
